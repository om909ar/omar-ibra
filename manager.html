<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ± â€“ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;font-family:'Tajawal',system-ui,-apple-system,Segoe UI,Arial;
    background:linear-gradient(#8e9a95,#7f8a85);color:#1f2421
  }
  .wrap{max-width:1200px;margin:0 auto;padding:20px}

  /* Ø±Ø£Ø³ */
  .head{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
  .head h1{margin:0;font-size:22px;color:#fff;text-shadow:0 1px 0 rgba(0,0,0,.25)}
  .meta{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .meta input[type=date], .meta input[type=text]{
    padding:8px 10px;border:1px solid #d5d8dc;border-radius:999px;background:#e9efe9;min-width:160px
  }

  /* ØªØ¨ÙˆÙŠØ¨Ø§Øª */
  .tabs{
    display:flex; gap:8px; justify-content:center; align-items:center;
    margin:14px auto 10px; padding:6px;
    background:#e9efe9; border-radius:999px;
    width:min(980px,94%); box-shadow:0 2px 0 rgba(0,0,0,.2) inset;
  }
  .tab{
    border:0; cursor:pointer; padding:10px 16px; border-radius:999px;
    background:#445a53; color:#e7efe9; font-weight:600;
    box-shadow:inset 0 0 0 1px rgba(255,255,255,.15), 0 2px 0 rgba(0,0,0,.2);
  }
  .tab.is-active{ background:#316655; color:#fff }

  .tabs-content{ width:min(1100px,94%); margin:0 auto }
  .tab-panel{ display:none }
  .tab-panel.is-active{ display:block }

  /* Ø¨Ø·Ø§Ù‚Ø©/Ù„ÙˆØ­Ø© */
  .panel{
    background:#e9eceb;border:1px solid rgba(0,0,0,.12);border-radius:10px;padding:16px;
    box-shadow:0 4px 0 rgba(0,0,0,.25);margin-top:20px
  }

  /* Ø£Ø¯ÙˆØ§Øª Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
  .btn{border:1px solid #c9ced3;background:#eef1f4;border-radius:10px;padding:8px 12px;cursor:pointer;
    display:inline-flex;align-items:center;gap:6px;font-weight:600}
  .btn.primary{background:#316655;color:#fff;border-color:#316655}
  .btn.accent{background:#2d6a8e;color:#fff;border-color:#2d6a8e}
  .btn.warn{background:#9c4131;color:#fff;border-color:#9c4131}
  .btn.ghost{background:#f4f6f7}
  .search{margin-inline-start:auto;padding:8px 10px;border:1px solid #c9ced3;border-radius:10px;background:#fff;min-width:200px}

  /* Ø¬Ø¯ÙˆÙ„ */
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  thead th{font-size:13px;color:#2b3330;text-align:right;padding:6px 4px}
  tbody td{
    background:#f9fbfc;border:1px solid #dfe5e2;padding:10px;border-radius:10px;vertical-align:middle
  }
  tbody input[type=text], tbody input[type=time], tbody select{
    width:100%;padding:8px 10px;border:1px solid #cfd6d2;border-radius:8px;background:#fff
  }
  .empty{padding:14px;background:#fff;border:1px dashed #c9ced3;border-radius:10px;text-align:center}

  .sum{margin-top:10px;font-size:14px;color:#2b3330}
  .hint{font-size:12px;color:#2b3330;margin-top:10px}

  /* Ø¨Ø·Ø§Ù‚Ø§Øª Ù…Ø¹Ù„ÙˆÙ…Ø§Øª */
  .cards{ display:grid; grid-template-columns:repeat(4, minmax(160px,1fr)); gap:12px; margin:16px 0 }
  .card{
    background:#e9eceb; border:1px solid rgba(0,0,0,.12); border-radius:10px;
    box-shadow:0 4px 0 rgba(0,0,0,.25); padding:14px;
  }
  .card-title{ font-size:13px; color:#2b3330; margin-bottom:6px }
  .card-value{ font-size:20px; font-weight:700 }

  .info-block{ background:#fff; border:1px solid #e1e5e2; border-radius:10px; padding:14px; box-shadow:0 1px 2px rgba(0,0,0,.04) }
  .list{ margin:0; padding:0 18px }

  /* ØªÙˆØ³Øª */
  .toast{position:fixed;inset-inline:0;bottom:16px;display:flex;justify-content:center;pointer-events:none;z-index:9999}
  .toast span{background:#111;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transform:translateY(10px);transition:.2s}
  .toast.show span{opacity:1;transform:none}

  @media (max-width:920px){ .cards{ grid-template-columns:repeat(2, minmax(160px,1fr)) } }
</style>
</head>
<body>
<div class="wrap">
  <header class="head">
    <h1>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ± â€“ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù</h1>
    <div class="meta">
      <label>Ø§Ù„ØªØ§Ø±ÙŠØ®:
        <input type="date" id="day">
      </label>
      <label>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©:
        <input type="text" id="dept" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©/Ø§Ù„Ù‚Ø³Ù…">
      </label>
    </div>
  </header>

  <!-- Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
  <nav class="tabs" role="tablist" aria-label="Ù…Ø¯ÙŠØ±">
    <button class="tab is-active" role="tab" aria-selected="true" data-tab="info">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</button>
    <button class="tab" role="tab" aria-selected="false" data-tab="attend">ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
  </nav>

  <main class="tabs-content">
    <!-- ØªØ¨ÙˆÙŠØ¨: Ù…Ø¹Ù„ÙˆÙ…Ø§Øª -->
    <section id="tab-info" class="tab-panel is-active" role="tabpanel" aria-labelledby="tab-info">
      <section class="panel">
        <div class="cards">
          <div class="card">
            <div class="card-title">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…</div>
            <div class="card-value" id="infoDate">â€”</div>
          </div>
          <div class="card">
            <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
            <div class="card-value" id="infoTotal">â€”</div>
          </div>
          <div class="card">
            <div class="card-title">Ø§Ù„Ø­Ø¶ÙˆØ±</div>
            <div class="card-value" id="infoPresent">â€”</div>
          </div>
          <div class="card">
            <div class="card-title">Ù…ØªØ£Ø®Ø±/ØºÙŠØ§Ø¨/Ø¥Ø¬Ø§Ø²Ø©/Ø§Ø³ØªØ¦Ø°Ø§Ù†</div>
            <div class="card-value" id="infoOther">â€”</div>
          </div>
        </div>

        <div class="info-block">
          <h3>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø³Ø±ÙŠØ¹Ø©</h3>
          <ul id="infoNotes" class="list"></ul>
        </div>
      </section>
    </section>

    <!-- ØªØ¨ÙˆÙŠØ¨: ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© -->
    <section id="tab-attend" class="tab-panel" role="tabpanel" aria-labelledby="tab-attend">
      <section class="panel">
        <div class="toolbar">
          <button id="addRow" class="btn ghost">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù</button>
          <button id="saveDay" class="btn primary">Ø­ÙØ¸ Ø§Ù„ÙŠÙˆÙ…</button>
          <button id="exportCSV" class="btn accent">ØªØµØ¯ÙŠØ± CSV</button>
          <button id="finalize" class="btn warn">ØªÙˆØ¬ÙŠÙ‡ Ù„Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©</button>
          <input id="search" class="search" type="text" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…â€¦">
        </div>

        <div class="table-wrap">
          <table id="tbl" aria-label="Ø³Ø¬Ù„ Ø§Ù„ÙŠÙˆÙ…">
            <thead>
              <tr>
                <th style="width:22%">Ø§Ù„Ù…ÙˆØ¸Ù</th>
                <th style="width:12%">Ø§Ù„Ù…Ø±ØªØ¨Ø©</th>
                <th style="width:12%">Ø§Ù„Ø­Ø¶ÙˆØ±</th>
                <th style="width:12%">Ø§Ù„Ø§Ù†ØµØ±Ø§Ù</th>
                <th style="width:14%">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                <th style="width:10%">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
          <div id="empty" class="empty" hidden>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ….</div>
        </div>

        <div id="summary" class="sum">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 0 | Ø­Ø§Ø¶Ø±: 0 | Ù…ØªØ£Ø®Ø±: 0 | ØºÙŠØ§Ø¨: 0 | Ø¥Ø¬Ø§Ø²Ø©: 0 | Ø§Ø³ØªØ¦Ø°Ø§Ù†: 0</div>
        <div class="hint">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¥Ø°Ø§ ÙˆØµÙ„Øª Ø§Ù„ØµÙØ­Ø© Ø¹Ø¨Ø± ØªØ­ÙˆÙŠÙ„ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ù…ÙˆØ¸ÙØŒ Ø³ÙŠØªÙ… Ø¯Ù…Ø¬ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø±Ø³Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù„Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø±ÙŠØ®.</div>
      </section>
    </section>
  </main>
</div>

<div class="toast" id="toast"><span></span></div>

<script>
(function(){
  /* ========== ØªØ¨ÙˆÙŠØ¨Ø§Øª ========== */
  const $ = (s,p=document)=>p.querySelector(s);
  const $$ = (s,p=document)=>Array.from(p.querySelectorAll(s));
  const tabs = $$('.tab');
  const panels = { info: $('#tab-info'), attend: $('#tab-attend') };

  function activate(name){
    tabs.forEach(t=>{
      const on = t.dataset.tab===name;
      t.classList.toggle('is-active', on);
      t.setAttribute('aria-selected', on?'true':'false');
    });
    Object.entries(panels).forEach(([k,el])=>{
      el.classList.toggle('is-active', k===name);
    });
    localStorage.setItem('mgr:view', name);
    if(name==='info') refreshInfo(); // Ø­Ø¯Ù‘Ø« â€œÙ…Ø¹Ù„ÙˆÙ…Ø§Øªâ€ Ø¹Ù†Ø¯ ÙØªØ­Ù‡Ø§
  }
  tabs.forEach(t=> t.addEventListener('click', ()=> activate(t.dataset.tab)));

  /* ========== Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ØªØ®Ø²ÙŠÙ† ========== */
  const MGR_KEY = 'mgr_records_v1';      // Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ±: { 'YYYY-MM-DD': [rows] }
  const DEPT_KEY = 'mgr_dept';           // Ø§Ø³Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
  const FINAL_KEY = 'mgr_finalized_v1';  // Ø­Ø§Ù„Ø§Øª Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ HR Ù„ÙƒÙ„ ÙŠÙˆÙ…

  /* ========== Ø¹Ù†Ø§ØµØ± Ø¹Ø§Ù…Ø© ========== */
  const dayEl = document.getElementById('day');
  const deptEl = document.getElementById('dept');
  const tbody = document.getElementById('tbody');
  const empty = document.getElementById('empty');
  const summary = document.getElementById('summary');
  const searchEl = document.getElementById('search');
  const addRowBtn = document.getElementById('addRow');
  const saveBtn = document.getElementById('saveDay');
  const exportBtn = document.getElementById('exportCSV');
  const finalizeBtn = document.getElementById('finalize');

  const toast = (msg)=>{ const t=document.getElementById('toast'); t.querySelector('span').textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1400); };
  const pad = n => String(n).padStart(2,'0');
  const todayISO = ()=>{ const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; };

  const load = (k, fb)=> { try{return JSON.parse(localStorage.getItem(k) || fb);}catch(_){return JSON.parse(fb);} };
  const save = (k, obj)=> localStorage.setItem(k, JSON.stringify(obj));

  /* ========== ØªØ§Ø±ÙŠØ® Ùˆ Ø¥Ø¯Ø§Ø±Ø© ========== */
  const params = new URLSearchParams(location.search);
  dayEl.value = params.get('date') || todayISO();

  deptEl.value = localStorage.getItem(DEPT_KEY) || '';
  deptEl.addEventListener('input', ()=> localStorage.setItem(DEPT_KEY, deptEl.value));

  /* ========== Ø¯ÙˆØ§Ù„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ÙŠÙˆÙ… ========== */
  function getDayRows(date){
    const all = load(MGR_KEY, '{}');
    return all[date] || [];
  }
  function setDayRows(date, rows){
    const all = load(MGR_KEY, '{}');
    all[date] = rows;
    save(MGR_KEY, all);
  }

  /* ========== Ø¯Ù…Ø¬ Ø³Ø¬Ù„ ÙˆØ§Ø±Ø¯ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ù…ÙˆØ¸Ù ========== */
  function mergeIncoming(){
    const raw = sessionStorage.getItem('last_attendance_payload');
    if(!raw) return false;
    const p = JSON.parse(raw);
    if(!p || !p.date || p.date !== dayEl.value) return false;

    let rows = getDayRows(dayEl.value);
    const name = (p.account && p.account.name) ? String(p.account.name).trim() : 'â€”';
    const rank = (p.account && p.account.rank) ? String(p.account.rank).trim() : 'â€”';
    const hudur = p.hudur || '';
    const insiraf = p.insiraf || '';

    const idx = rows.findIndex(r => (r.name||'').trim() === name);
    if(idx >= 0){
      rows[idx].hudur = hudur || rows[idx].hudur;
      rows[idx].insiraf = insiraf || rows[idx].insiraf;
      if(!rows[idx].rank) rows[idx].rank = rank;
    }else{
      rows.push({
        id: crypto.randomUUID(),
        name, rank,
        hudur, insiraf,
        status: '',
        note: ''
      });
    }
    setDayRows(dayEl.value, rows);
    sessionStorage.removeItem('last_attendance_payload');
    return true;
  }

  /* ========== Ø¨Ù†Ø§Ø¡ ØµÙ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ========== */
  function buildRow(r){
    const tr = document.createElement('tr');
    tr.dataset.id = r.id;

    const tdName = document.createElement('td');
    const inName = document.createElement('input'); inName.type='text'; inName.value=r.name||'';
    tdName.appendChild(inName);

    const tdRank = document.createElement('td');
    const inRank = document.createElement('input'); inRank.type='text'; inRank.value=r.rank||'';
    tdRank.appendChild(inRank);

    const tdHud = document.createElement('td');
    const inHud = document.createElement('input'); inHud.type='time'; inHud.value=r.hudur||'';
    tdHud.appendChild(inHud);

    const tdIns = document.createElement('td');
    const inIns = document.createElement('input'); inIns.type='time'; inIns.value=r.insiraf||'';
    tdIns.appendChild(inIns);

    const tdSt = document.createElement('td');
    const sel = document.createElement('select');
    ['','Ø­Ø§Ø¶Ø±','Ù…ØªØ£Ø®Ø±','ØºÙŠØ§Ø¨','Ø¥Ø¬Ø§Ø²Ø©','Ø§Ø³ØªØ¦Ø°Ø§Ù†'].forEach(v=>{
      const o=document.createElement('option'); o.value=v; o.textContent=(v||'â€” Ø§Ø®ØªØ± â€”');
      if(v===r.status) o.selected=true; sel.appendChild(o);
    });
    tdSt.appendChild(sel);

    const tdNote = document.createElement('td');
    const inNote = document.createElement('input'); inNote.type='text'; inNote.placeholder='Ù…Ù„Ø§Ø­Ø¸Ø©â€¦'; inNote.value=r.note||'';
    tdNote.appendChild(inNote);

    const tdAct = document.createElement('td');
    const del = document.createElement('button'); del.className='btn ghost'; del.textContent='Ø­Ø°Ù';
    tdAct.appendChild(del);

    [inName,inRank,inHud,inIns,sel,inNote].forEach(el=>{
      el.addEventListener('change', ()=> {
        const rows = getDayRows(dayEl.value);
        const i = rows.findIndex(x=>x.id===r.id);
        if(i>=0){
          rows[i].name = inName.value.trim();
          rows[i].rank = inRank.value.trim();
          rows[i].hudur = inHud.value;
          rows[i].insiraf = inIns.value;
          rows[i].status = sel.value;
          rows[i].note = inNote.value.trim();
          setDayRows(dayEl.value, rows);
          renderSummary(rows);
          if(currentTab()==='info') refreshInfo();
        }
      });
    });

    del.addEventListener('click', ()=>{
      let rows = getDayRows(dayEl.value);
      rows = rows.filter(x=>x.id!==r.id);
      setDayRows(dayEl.value, rows);
      render();
      if(currentTab()==='info') refreshInfo();
    });

    tr.append(tdName,tdRank,tdHud,tdIns,tdSt,tdNote,tdAct);
    return tr;
  }

  /* ========== Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ù„Ù…Ù„Ø®Øµ ========== */
  function render(){
    const q = searchEl.value.trim();
    const rows = getDayRows(dayEl.value);
    tbody.innerHTML = '';
    let shown = rows;

    if(q){
      const qq = q.toLowerCase();
      shown = rows.filter(r => (r.name||'').toLowerCase().includes(qq));
    }

    empty.hidden = shown.length!==0;
    shown.forEach(r => tbody.appendChild(buildRow(r)));
    renderSummary(rows);

    const finAll = load(FINAL_KEY,'{}');
    finalizeBtn.disabled = !!finAll[dayEl.value];
  }

  function renderSummary(rows){
    const total = rows.length;
    const count = s=> rows.filter(r=>r.status===s).length;
    summary.textContent = `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total} | Ø­Ø§Ø¶Ø±: ${count('Ø­Ø§Ø¶Ø±')} | Ù…ØªØ£Ø®Ø±: ${count('Ù…ØªØ£Ø®Ø±')} | ØºÙŠØ§Ø¨: ${count('ØºÙŠØ§Ø¨')} | Ø¥Ø¬Ø§Ø²Ø©: ${count('Ø¥Ø¬Ø§Ø²Ø©')} | Ø§Ø³ØªØ¦Ø°Ø§Ù†: ${count('Ø§Ø³ØªØ¦Ø°Ø§Ù†')}`;
  }

  /* ========== ØªØ¨ÙˆÙŠØ¨ "Ù…Ø¹Ù„ÙˆÙ…Ø§Øª" ========== */
  const infoDate = $('#infoDate');
  const infoTotal = $('#infoTotal');
  const infoPresent = $('#infoPresent');
  const infoOther = $('#infoOther');
  const infoNotes = $('#infoNotes');

  function refreshInfo(){
    const rows = getDayRows(dayEl.value);
    const total = rows.length;
    const present = rows.filter(r=>r.status==='Ø­Ø§Ø¶Ø±').length;
    const other = total - present;

    infoDate.textContent = dayEl.value;
    infoTotal.textContent = total || '0';
    infoPresent.textContent = present || '0';
    infoOther.textContent = other || '0';

    infoNotes.innerHTML = '';
    const li = document.createElement('li');
    if(total===0){
      li.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ….';
    }else if(present===total){
      li.textContent = 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø­Ø§Ø¶Ø±ÙŠÙ† âœ…';
    }else{
      li.textContent = 'Ù‡Ù†Ø§Ùƒ Ø­Ø§Ù„Ø§Øª ØªØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø© (Ù…ØªØ£Ø®Ø±/ØºÙŠØ§Ø¨/Ø¥Ø¬Ø§Ø²Ø©/Ø§Ø³ØªØ¦Ø°Ø§Ù†) âš ï¸';
    }
    infoNotes.appendChild(li);
  }

  /* ========== Ø£Ø­Ø¯Ø§Ø« Ø¹Ø§Ù…Ø© ========== */
  const currentTab = ()=> localStorage.getItem('mgr:view') || 'info';

  dayEl.addEventListener('change', ()=> { render(); if(currentTab()==='info') refreshInfo(); });

  searchEl && searchEl.addEventListener('input', ()=> render());

  addRowBtn.addEventListener('click', ()=>{
    const rows = getDayRows(dayEl.value);
    rows.push({ id: crypto.randomUUID(), name:'', rank:'', hudur:'', insiraf:'', status:'', note:'' });
    setDayRows(dayEl.value, rows);
    render();
    if(currentTab()==='info') refreshInfo();
  });

  saveBtn.addEventListener('click', ()=>{ toast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙŠÙˆÙ….'); });

  exportBtn.addEventListener('click', ()=>{
    const rows = getDayRows(dayEl.value);
    const head = ['Ø§Ù„Ø§Ø³Ù…','Ø§Ù„Ù…Ø±ØªØ¨Ø©','Ø§Ù„Ø­Ø¶ÙˆØ±','Ø§Ù„Ø§Ù†ØµØ±Ø§Ù','Ø§Ù„Ø­Ø§Ù„Ø©','Ù…Ù„Ø§Ø­Ø¸Ø§Øª'];
    const lines = [head.join(',')];
    rows.forEach(r=>{
      const cells = [r.name||'',r.rank||'',r.hudur||'',r.insiraf||'',r.status||'', (r.note||'').replace(/,/g,';')];
      lines.push(cells.map(v=>`"${(v||'').replace(/"/g,'""')}"`).join(','));
    });
    const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href=url; a.download=`attendance_${dayEl.value}.csv`; a.click();
    URL.revokeObjectURL(url);
  });

  finalizeBtn.addEventListener('click', ()=>{
    const finAll = load(FINAL_KEY,'{}');
    if(finAll[dayEl.value]){ toast('ØªÙ… ØªÙˆØ¬ÙŠÙ‡ Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ… Ù…Ø³Ø¨Ù‚Ù‹Ø§.'); return; }
    finAll[dayEl.value] = { dept: deptEl.value || '', timestamp: new Date().toISOString() };
    save(FINAL_KEY, finAll);
    finalizeBtn.disabled = true;
    toast('ØªÙ… Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ© ğŸ¯');
  });

  /* ========== Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ ========== */
  // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…ÙØ¶Ù„ (Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª)
  activate(localStorage.getItem('mgr:view') || 'info');

  // Ø¯Ù…Ø¬ Ø³Ø¬Ù„ ÙˆØ§Ø±Ø¯ Ø«Ù… Ø§Ø±Ø³Ù…
  mergeIncoming();
  render();
  // Ù„Ùˆ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªØŒ Ø­Ø¯Ù‘Ø«Ù‡ Ø§Ù„Ø¢Ù†
  if((localStorage.getItem('mgr:view') || 'info')==='info') refreshInfo();
})();
</script>
</body>
</html>
