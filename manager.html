<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>لوحة المدير – الحضور والانصراف</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;font-family:'Tajawal',system-ui,-apple-system,Segoe UI,Arial;
    background:linear-gradient(#8e9a95,#7f8a85);color:#1f2421
  }
  .wrap{max-width:1200px;margin:0 auto;padding:20px}

  /* رأس */
  .head{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
  .head h1{margin:0;font-size:22px;color:#fff;text-shadow:0 1px 0 rgba(0,0,0,.25)}
  .meta{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .meta input[type=date], .meta input[type=text]{
    padding:8px 10px;border:1px solid #d5d8dc;border-radius:999px;background:#e9efe9;min-width:160px
  }

  /* تبويبات */
  .tabs{
    display:flex; gap:8px; justify-content:center; align-items:center;
    margin:14px auto 10px; padding:6px;
    background:#e9efe9; border-radius:999px;
    width:min(980px,94%); box-shadow:0 2px 0 rgba(0,0,0,.2) inset;
  }
  .tab{
    border:0; cursor:pointer; padding:10px 16px; border-radius:999px;
    background:#445a53; color:#e7efe9; font-weight:600;
    box-shadow:inset 0 0 0 1px rgba(255,255,255,.15), 0 2px 0 rgba(0,0,0,.2);
  }
  .tab.is-active{ background:#316655; color:#fff }

  .tabs-content{ width:min(1100px,94%); margin:0 auto }
  .tab-panel{ display:none }
  .tab-panel.is-active{ display:block }

  /* لوحة */
  .panel{
    background:#e9eceb;border:1px solid rgba(0,0,0,.12);border-radius:10px;padding:16px;
    box-shadow:0 4px 0 rgba(0,0,0,.25);margin-top:20px
  }

  /* أدوات أعلى الجدول */
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
  .btn{border:1px solid #c9ced3;background:#eef1f4;border-radius:10px;padding:8px 12px;cursor:pointer;
    display:inline-flex;align-items:center;gap:6px;font-weight:600}
  .btn.primary{background:#316655;color:#fff;border-color:#316655}
  .btn.accent{background:#2d6a8e;color:#fff;border-color:#2d6a8e}
  .btn.warn{background:#9c4131;color:#fff;border-color:#9c4131}
  .btn.ghost{background:#f4f6f7}
  .search{margin-inline-start:auto;padding:8px 10px;border:1px solid #c9ced3;border-radius:10px;background:#fff;min-width:200px}

  /* جدول */
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  thead th{font-size:13px;color:#2b3330;text-align:right;padding:6px 4px}
  tbody td{
    background:#f9fbfc;border:1px solid #dfe5e2;padding:10px;border-radius:10px;vertical-align:middle
  }
  tbody input[type=text], tbody input[type=time], tbody select{
    width:100%;padding:8px 10px;border:1px solid #cfd6d2;border-radius:8px;background:#fff
  }
  .empty{padding:14px;background:#fff;border:1px dashed #c9ced3;border-radius:10px;text-align:center}

  .sum{margin-top:10px;font-size:14px;color:#2b3330}
  .hint{font-size:12px;color:#2b3330;margin-top:10px}

  /* نموذج المدير الشخصي */
  .sub{margin:16px 0 8px;font-size:16px}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .row.two > *{flex:1 1 240px}
  .row.four > *{flex:1 1 160px}
  label{display:flex;flex-direction:column;gap:6px}
  input[type=text],input[type=time],select{
    padding:10px 12px;border:1px solid #cfd6d2;border-radius:8px;background:#fff;min-width:160px
  }
  .btn .ic{width:18px;height:18px}
  .log{list-style:none;margin:8px 0 0;padding:0}
  .log li{background:#f9fbfc;border:1px solid #dfe5e2;padding:8px 10px;border-radius:8px;margin-bottom:6px;font-size:14px}

  /* توست */
  .toast{position:fixed;inset-inline:0;bottom:16px;display:flex;justify-content:center;pointer-events:none;z-index:9999}
  .toast span{background:#111;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transform:translateY(10px);transition:.2s}
  .toast.show span{opacity:1;transform:none}

  /* تلوين اختياري حسب الحالة */
  .row-present{outline:2px solid #2e7d32}
  .row-late{outline:2px solid #ff8f00}
  .row-absent{outline:2px solid #c62828}
  .row-leave{outline:2px solid #1565c0}
  .row-permit{outline:2px solid #6a1b9a}
</style>
</head>
<body>
<div class="wrap">
  <header class="head">
    <h1>لوحة المدير – الحضور والانصراف</h1>
    <div class="meta">
      <label>التاريخ:
        <input type="date" id="day">
      </label>
      <label>الإدارة:
        <input type="text" id="dept" placeholder="اسم الإدارة/القسم">
      </label>
    </div>
  </header>

  <!-- التبويبات -->
  <nav class="tabs" role="tablist" aria-label="مدير">
    <button class="tab is-active" role="tab" aria-selected="true" data-tab="dept">تحضير الإدارة</button>
    <button class="tab" role="tab" aria-selected="false" data-tab="mgr">حضور المدير</button>
  </nav>

  <main class="tabs-content">
    <!-- تبويب: تحضير الإدارة -->
    <section id="tab-dept" class="tab-panel is-active" role="tabpanel" aria-labelledby="tab-dept">
      <section class="panel">
        <div class="toolbar">
          <button id="addRow" class="btn ghost">إضافة موظف</button>
          <button id="saveDay" class="btn primary">حفظ اليوم</button>
          <button id="exportCSV" class="btn accent">تصدير CSV</button>
          <button id="finalize" class="btn warn">توجيه للموارد البشرية</button>
          <input id="search" class="search" type="text" placeholder="بحث بالاسم…">
        </div>

        <div class="table-wrap">
          <table id="tbl" aria-label="سجل اليوم">
            <thead>
              <tr>
                <th style="width:22%">الموظف</th>
                <th style="width:12%">المرتبة</th>
                <th style="width:12%">الحضور</th>
                <th style="width:12%">الانصراف</th>
                <th style="width:14%">الحالة</th>
                <th>ملاحظات</th>
                <th style="width:10%">إجراءات</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
          <div id="empty" class="empty" hidden>لا يوجد سجلات لهذا اليوم.</div>
        </div>

        <div id="summary" class="sum">الإجمالي: 0 | حاضر: 0 | متأخر: 0 | غياب: 0 | إجازة: 0 | استئذان: 0</div>
        <div class="hint">ملاحظة: إذا وصلت الصفحة عبر تحويل من صفحة الموظف، سيتم دمج السجل المرسل تلقائيًا لهذا التاريخ.</div>
      </section>
    </section>

    <!-- تبويب: حضور المدير (نفس تحضير الموظفين) -->
    <section id="tab-mgr" class="tab-panel" role="tabpanel" aria-labelledby="tab-mgr">
      <section class="panel">
        <h2 style="margin:0 0 10px;font-size:18px">حضور المدير (شخصي)</h2>

        <div class="row two">
          <label>الاسم
            <input type="text" id="mgrSelfName" placeholder="اسم المدير">
          </label>
          <label>المرتبة/الدرجة
            <input type="text" id="mgrSelfRank" placeholder="مثال: مدير إدارة / المرتبة العاشرة">
          </label>
        </div>

        <h3 class="sub">التحضير</h3>
        <div class="row four">
          <label>الوقت
            <input type="time" id="mgrSelfTime">
          </label>

          <label>نوع الطلب (اختياري)
            <select id="mgrSelfReq">
              <option value="">— بدون طلب —</option>
              <option value="partial">استئذان جزئي</option>
              <option value="full">استئذان كلي</option>
              <option value="leave">إجازة</option>
            </select>
          </label>

          <button id="mgrSelfIn" class="btn primary">
            <svg class="ic" viewBox="0 0 24 24" aria-hidden="true"><path d="M3 12h11m-3-3l3 3-3 3M7 5h10a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H7" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
            تسجيل حضور
          </button>

          <button id="mgrSelfOut" class="btn">
            <svg class="ic" viewBox="0 0 24 24" aria-hidden="true"><path d="M14 12H3m3 3-3-3 3-3M7 5h10a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H7" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
            تسجيل انصراف
          </button>
        </div>

        <div class="list">
          <h3 class="sub">سجل اليوم</h3>
          <ul id="mgrSelfLog" class="log"></ul>
        </div>
      </section>
    </section>
  </main>
</div>

<div class="toast" id="toast"><span></span></div>

<script>
(function(){
  /* ===== مساعدات عامة ===== */
  const $ = (s,p=document)=>p.querySelector(s);
  const $$ = (s,p=document)=>Array.from(p.querySelectorAll(s));
  const toast = (msg)=>{ const t=document.getElementById('toast'); t.querySelector('span').textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1400); };
  const pad = n => String(n).padStart(2,'0');
  const todayISO = ()=>{ const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; };
  const nowHM = ()=>{ const d=new Date(); return d.toTimeString().slice(0,5); };

  /* ===== تبويبات ===== */
  const tabs = $$('.tab');
  const panels = { dept: $('#tab-dept'), mgr: $('#tab-mgr') };
  function activate(name){
    tabs.forEach(t=>{
      const on = t.dataset.tab===name;
      t.classList.toggle('is-active', on);
      t.setAttribute('aria-selected', on?'true':'false');
    });
    Object.entries(panels).forEach(([k,el])=>{
      el.classList.toggle('is-active', k===name);
    });
    localStorage.setItem('mgr:view', name);
  }
  tabs.forEach(t=> t.addEventListener('click', ()=> activate(t.dataset.tab)));

  /* ===== تخزين ===== */
  const MGR_KEY = 'mgr_records_v1';      // { 'YYYY-MM-DD': [rows] }
  const DEPT_KEY = 'mgr_dept';
  const FINAL_KEY = 'mgr_finalized_v1';

  const load = (k, fb)=> { try{return JSON.parse(localStorage.getItem(k) || fb);}catch(_){return JSON.parse(fb);} };
  const save = (k, obj)=> localStorage.setItem(k, JSON.stringify(obj));

  /* ===== عناصر عامة (تبويب الإدارة) ===== */
  const dayEl = document.getElementById('day');
  const deptEl = document.getElementById('dept');
  const tbody = document.getElementById('tbody');
  const empty = document.getElementById('empty');
  const summary = document.getElementById('summary');
  const searchEl = document.getElementById('search');
  const addRowBtn = document.getElementById('addRow');
  const saveBtn = document.getElementById('saveDay');
  const exportBtn = document.getElementById('exportCSV');
  const finalizeBtn = document.getElementById('finalize');

  const params = new URLSearchParams(location.search);
  dayEl.value = params.get('date') || todayISO();
  deptEl.value = localStorage.getItem(DEPT_KEY) || '';
  deptEl.addEventListener('input', ()=> localStorage.setItem(DEPT_KEY, deptEl.value));

  function getDayRows(date){
    const all = load(MGR_KEY, '{}');
    return all[date] || [];
  }
  function setDayRows(date, rows){
    const all = load(MGR_KEY, '{}');
    all[date] = rows;
    save(MGR_KEY, all);
  }

  /* ===== دمج سجل وارد من صفحة الموظف ===== */
  function mergeIncoming(){
    const raw = sessionStorage.getItem('last_attendance_payload');
    if(!raw) return false;
    const p = JSON.parse(raw);
    if(!p || !p.date || p.date !== dayEl.value) return false;

    let rows = getDayRows(dayEl.value);
    const name = (p.account && p.account.name) ? String(p.account.name).trim() : '—';
    const rank = (p.account && p.account.rank) ? String(p.account.rank).trim() : '—';
    const hudur = p.hudur || '';
    const insiraf = p.insiraf || '';

    const idx = rows.findIndex(r => (r.name||'').trim() === name);
    if(idx >= 0){
      rows[idx].hudur = hudur || rows[idx].hudur;
      rows[idx].insiraf = insiraf || rows[idx].insiraf;
      if(!rows[idx].rank) rows[idx].rank = rank;
    }else{
      rows.push({ id: crypto.randomUUID(), name, rank, hudur, insiraf, status:'', note:'' });
    }
    setDayRows(dayEl.value, rows);
    sessionStorage.removeItem('last_attendance_payload');
    return true;
  }

  /* ===== بناء صف جدول الإدارة ===== */
  function statusClass(v){
    return v==='حاضر'?'row-present' : v==='متأخر'?'row-late' : v==='غياب'?'row-absent' : v==='إجازة'?'row-leave' : v==='استئذان'?'row-permit' : '';
  }
  function buildRow(r){
    const tr = document.createElement('tr');
    tr.dataset.id = r.id;
    if(r.status) tr.classList.add(statusClass(r.status));

    const tdName = document.createElement('td');
    const inName = document.createElement('input'); inName.type='text'; inName.value=r.name||'';
    tdName.appendChild(inName);

    const tdRank = document.createElement('td');
    const inRank = document.createElement('input'); inRank.type='text'; inRank.value=r.rank||'';
    tdRank.appendChild(inRank);

    const tdHud = document.createElement('td');
    const inHud = document.createElement('input'); inHud.type='time'; inHud.value=r.hudur||'';
    tdHud.appendChild(inHud);

    const tdIns = document.createElement('td');
    const inIns = document.createElement('input'); inIns.type='time'; inIns.value=r.insiraf||'';
    tdIns.appendChild(inIns);

    const tdSt = document.createElement('td');
    const sel = document.createElement('select');
    ['','حاضر','متأخر','غياب','إجازة','استئذان'].forEach(v=>{
      const o=document.createElement('option'); o.value=v; o.textContent=(v||'— اختر —');
      if(v===r.status) o.selected=true; sel.appendChild(o);
    });
    tdSt.appendChild(sel);

    const tdNote = document.createElement('td');
    const inNote = document.createElement('input'); inNote.type='text'; inNote.placeholder='ملاحظة…'; inNote.value=r.note||'';
    tdNote.appendChild(inNote);

    const tdAct = document.createElement('td');
    const del = document.createElement('button'); del.className='btn ghost'; del.textContent='حذف';
    tdAct.appendChild(del);

    function persist(){
      const rows = getDayRows(dayEl.value);
      const i = rows.findIndex(x=>x.id===r.id);
      if(i>=0){
        rows[i].name = inName.value.trim();
        rows[i].rank = inRank.value.trim();
        rows[i].hudur = inHud.value;
        rows[i].insiraf = inIns.value;
        rows[i].status = sel.value;
        rows[i].note = inNote.value.trim();
        setDayRows(dayEl.value, rows);
        renderSummary(rows);
        tr.className=''; if(sel.value) tr.classList.add(statusClass(sel.value));
      }
    }
    [inName,inRank,inHud,inIns,sel,inNote].forEach(el=> el.addEventListener('change', persist));

    del.addEventListener('click', ()=>{
      let rows = getDayRows(dayEl.value);
      rows = rows.filter(x=>x.id!==r.id);
      setDayRows(dayEl.value, rows);
      render();
    });

    tr.append(tdName,tdRank,tdHud,tdIns,tdSt,tdNote,tdAct);
    return tr;
  }

  /* ===== رسم جدول الإدارة ===== */
  function render(){
    const q = searchEl.value.trim();
    const rows = getDayRows(dayEl.value);
    tbody.innerHTML = '';
    let shown = rows;

    if(q){
      const qq = q.toLowerCase();
      shown = rows.filter(r => (r.name||'').toLowerCase().includes(qq));
    }

    empty.hidden = shown.length!==0;
    shown.forEach(r => tbody.appendChild(buildRow(r)));
    renderSummary(rows);

    const finAll = load(FINAL_KEY,'{}');
    finalizeBtn.disabled = !!finAll[dayEl.value];
  }

  function renderSummary(rows){
    const total = rows.length;
    const count = s=> rows.filter(r=>r.status===s).length;
    summary.textContent = `الإجمالي: ${total} | حاضر: ${count('حاضر')} | متأخر: ${count('متأخر')} | غياب: ${count('غياب')} | إجازة: ${count('إجازة')} | استئذان: ${count('استئذان')}`;
  }

  /* ===== أزرار الإدارة ===== */
  dayEl.addEventListener('change', ()=> render());
  searchEl.addEventListener('input', ()=> render());

  addRowBtn.addEventListener('click', ()=>{
    const rows = getDayRows(dayEl.value);
    rows.push({ id: crypto.randomUUID(), name:'', rank:'', hudur:'', insiraf:'', status:'', note:'' });
    setDayRows(dayEl.value, rows);
    render();
  });

  saveBtn.addEventListener('click', ()=> toast('تم حفظ اليوم.'));
  exportBtn.addEventListener('click', ()=>{
    const rows = getDayRows(dayEl.value);
    const head = ['الاسم','المرتبة','الحضور','الانصراف','الحالة','ملاحظات'];
    const lines = [head.join(',')];
    rows.forEach(r=>{
      const cells = [r.name||'',r.rank||'',r.hudur||'',r.insiraf||'',r.status||'', (r.note||'').replace(/,/g,';')];
      lines.push(cells.map(v=>`"${(v||'').replace(/"/g,'""')}"`).join(','));
    });
    const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href=url; a.download=`attendance_${dayEl.value}.csv`; a.click();
    URL.revokeObjectURL(url);
  });
  finalizeBtn.addEventListener('click', ()=>{
    const finAll = load(FINAL_KEY,'{}');
    if(finAll[dayEl.value]){ toast('تم توجيه هذا اليوم مسبقًا.'); return; }
    finAll[dayEl.value] = { dept: deptEl.value || '', timestamp: new Date().toISOString() };
    save(FINAL_KEY, finAll);
    finalizeBtn.disabled = true;
    toast('تم التوجيه للموارد البشرية 🎯');
  });

  /* ===== تبويب: حضور المدير ===== */
  const mgrSelfName = document.getElementById('mgrSelfName');
  const mgrSelfRank = document.getElementById('mgrSelfRank');
  const mgrSelfTime = document.getElementById('mgrSelfTime');
  const mgrSelfReq  = document.getElementById('mgrSelfReq');
  const mgrSelfIn   = document.getElementById('mgrSelfIn');
  const mgrSelfOut  = document.getElementById('mgrSelfOut');
  const mgrSelfLog  = document.getElementById('mgrSelfLog');

  function reqLabel(v){ return v==='partial'?'استئذان جزئي' : v==='full'?'استئذان كلي' : v==='leave'?'إجازة' : ''; }
  function keySelf(prefix){ return `${prefix}:${dayEl.value}:mgrSelf`; }
  function loadSelfLog(){
    mgrSelfLog.innerHTML='';
    const arr = load(keySelf('mgrSelfLog'), '[]');
    arr.forEach(item=>{ const li=document.createElement('li'); li.textContent=item; mgrSelfLog.appendChild(li); });
  }
  function pushSelfLog(text){
    const arr = load(keySelf('mgrSelfLog'), '[]');
    arr.push(text); save(keySelf('mgrSelfLog'), arr); loadSelfLog();
  }
  function ensureManagerRow(){
    const name = (mgrSelfName.value||'').trim(); const rank = (mgrSelfRank.value||'').trim();
    if(!name) return null;
    let rows = getDayRows(dayEl.value);
    let r = rows.find(x => (x.name||'').trim() === name);
    if(!r){ r = { id: crypto.randomUUID(), name, rank, hudur:'', insiraf:'', status:'', note:'' }; rows.push(r); }
    else if(rank && !r.rank){ r.rank = rank; }
    setDayRows(dayEl.value, rows); return r.id;
  }
  function setManagerHudur(time){
    const id = ensureManagerRow(); if(!id) return;
    let rows = getDayRows(dayEl.value); const i = rows.findIndex(x=>x.id===id);
    if(i>=0){ rows[i].hudur = time; setDayRows(dayEl.value, rows); render(); }
  }
  function setManagerInsiraf(time){
    const id = ensureManagerRow(); if(!id) return;
    let rows = getDayRows(dayEl.value); const i = rows.findIndex(x=>x.id===id);
    if(i>=0){ rows[i].insiraf = time; setDayRows(dayEl.value, rows); render(); }
  }

  function hydrateManagerIdentity(){
    const p = new URLSearchParams(location.search);
    const storedName = localStorage.getItem('managerName') || '';
    const storedRank = localStorage.getItem('managerRank') || '';
    const finalName = (p.get('name')||storedName||'').trim();
    const finalRank = (p.get('rank')||storedRank||'').trim();
    if(finalName) localStorage.setItem('managerName', finalName);
    if(finalRank) localStorage.setItem('managerRank', finalRank);
    mgrSelfName.value = finalName;
    mgrSelfRank.value = finalRank;
  }

  function initSelfPanel(){
    if(!mgrSelfTime) return;
    mgrSelfTime.value = nowHM();
    hydrateManagerIdentity();
    loadSelfLog();

    [mgrSelfName, mgrSelfRank].forEach(el=>{
      el && el.addEventListener('change', ()=>{
        if(el===mgrSelfName) localStorage.setItem('managerName', (mgrSelfName.value||'').trim());
        if(el===mgrSelfRank) localStorage.setItem('managerRank', (mgrSelfRank.value||'').trim());
      });
    });

    mgrSelfIn && mgrSelfIn.addEventListener('click', ()=>{
      const n = (mgrSelfName.value||'مدير').trim();
      const r = (mgrSelfRank.value||'—').trim();
      const t = mgrSelfTime.value || nowHM();
      const extra = reqLabel(mgrSelfReq.value);
      pushSelfLog(`حضور: ${n} (${r}) عند ${t}${extra?(' — '+extra):''}`);
      setManagerHudur(t);
      toast('تم تسجيل حضور المدير');
    });

    mgrSelfOut && mgrSelfOut.addEventListener('click', ()=>{
      const n = (mgrSelfName.value||'مدير').trim();
      const r = (mgrSelfRank.value||'—').trim();
      const t = mgrSelfTime.value || nowHM();
      const extra = reqLabel(mgrSelfReq.value);
      pushSelfLog(`انصراف: ${n} (${r}) عند ${t}${extra?(' — '+extra):''}`);
      setManagerInsiraf(t);
      toast('تم تسجيل انصراف المدير');
    });
  }

  /* ===== بدء التشغيل ===== */
  activate(localStorage.getItem('mgr:view') || 'dept'); // افتراضي: تحضير الإدارة
  mergeIncoming();
  render();
  initSelfPanel();
})();
</script>
</body>
</html>