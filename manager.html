<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ± â€“ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;font-family:'Tajawal',system-ui,-apple-system,Segoe UI,Arial;
    background:linear-gradient(#8e9a95,#7f8a85);color:#1f2421
  }
  .wrap{max-width:1200px;margin:0 auto;padding:20px}

  /* Ø±Ø£Ø³ */
  .head{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
  .head h1{margin:0;font-size:22px;color:#fff;text-shadow:0 1px 0 rgba(0,0,0,.25)}
  .meta{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .meta input[type=date], .meta input[type=text]{
    padding:8px 10px;border:1px solid #d5d8dc;border-radius:999px;background:#e9efe9;min-width:160px
  }

  /* ØªØ¨ÙˆÙŠØ¨Ø§Øª */
  .tabs{
    display:flex; gap:8px; justify-content:center; align-items:center;
    margin:14px auto 10px; padding:6px;
    background:#e9efe9; border-radius:999px;
    width:min(980px,94%); box-shadow:0 2px 0 rgba(0,0,0,.2) inset;
  }
  .tab{
    border:0; cursor:pointer; padding:10px 16px; border-radius:999px;
    background:#445a53; color:#e7efe9; font-weight:600;
    box-shadow:inset 0 0 0 1px rgba(255,255,255,.15), 0 2px 0 rgba(0,0,0,.2);
  }
  .tab.is-active{ background:#316655; color:#fff }

  .tabs-content{ width:min(1100px,94%); margin:0 auto }
  .tab-panel{ display:none }
  .tab-panel.is-active{ display:block }

  /* Ù„ÙˆØ­Ø© */
  .panel{
    background:#e9eceb;border:1px solid rgba(0,0,0,.12);border-radius:10px;padding:16px;
    box-shadow:0 4px 0 rgba(0,0,0,.25);margin-top:20px
  }

  /* Ø£Ø¯ÙˆØ§Øª Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
  .btn{border:1px solid #c9ced3;background:#eef1f4;border-radius:10px;padding:8px 12px;cursor:pointer;
    display:inline-flex;align-items:center;gap:6px;font-weight:600}
  .btn.primary{background:#316655;color:#fff;border-color:#316655}
  .btn.accent{background:#2d6a8e;color:#fff;border-color:#2d6a8e}
  .btn.warn{background:#9c4131;color:#fff;border-color:#9c4131}
  .btn.ghost{background:#f4f6f7}
  .search{margin-inline-start:auto;padding:8px 10px;border:1px solid #c9ced3;border-radius:10px;background:#fff;min-width:200px}

  /* Ø¬Ø¯ÙˆÙ„ */
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  thead th{font-size:13px;color:#2b3330;text-align:right;padding:6px 4px}
  tbody td{
    background:#f9fbfc;border:1px solid #dfe5e2;padding:10px;border-radius:10px;vertical-align:middle
  }
  tbody input[type=text], tbody input[type=time], tbody select{
    width:100%;padding:8px 10px;border:1px solid #cfd6d2;border-radius:8px;background:#fff
  }
  .empty{padding:14px;background:#fff;border:1px dashed #c9ced3;border-radius:10px;text-align:center}

  .sum{margin-top:10px;font-size:14px;color:#2b3330}
  .hint{font-size:12px;color:#2b3330;margin-top:10px}

  /* Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø´Ø®ØµÙŠ */
  .sub{margin:16px 0 8px;font-size:16px}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .row.two > *{flex:1 1 240px}
  .row.four > *{flex:1 1 160px}
  label{display:flex;flex-direction:column;gap:6px}
  input[type=text],input[type=time],select{
    padding:10px 12px;border:1px solid #cfd6d2;border-radius:8px;background:#fff;min-width:160px
  }
  .btn .ic{width:18px;height:18px}
  .log{list-style:none;margin:8px 0 0;padding:0}
  .log li{background:#f9fbfc;border:1px solid #dfe5e2;padding:8px 10px;border-radius:8px;margin-bottom:6px;font-size:14px}

  /* ØªÙˆØ³Øª */
  .toast{position:fixed;inset-inline:0;bottom:16px;display:flex;justify-content:center;pointer-events:none;z-index:9999}
  .toast span{background:#111;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transform:translateY(10px);transition:.2s}
  .toast.show span{opacity:1;transform:none}

  /* ØªÙ„ÙˆÙŠÙ† Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© */
  .row-present{outline:2px solid #2e7d32}
  .row-late{outline:2px solid #ff8f00}
  .row-absent{outline:2px solid #c62828}
  .row-leave{outline:2px solid #1565c0}
  .row-permit{outline:2px solid #6a1b9a}
</style>
</head>
<body>
<div class="wrap">
  <header class="head">
    <h1>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ± â€“ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù</h1>
    <div class="meta">
      <label>Ø§Ù„ØªØ§Ø±ÙŠØ®:
        <input type="date" id="day">
      </label>
      <label>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©:
        <input type="text" id="dept" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©/Ø§Ù„Ù‚Ø³Ù…">
      </label>
    </div>
  </header>

  <!-- Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
  <nav class="tabs" role="tablist" aria-label="Ù…Ø¯ÙŠØ±">
    <button class="tab is-active" role="tab" aria-selected="true" data-tab="dept">ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
    <button class="tab" role="tab" aria-selected="false" data-tab="mgr">Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø¯ÙŠØ±</button>
  </nav>

  <main class="tabs-content">
    <!-- ØªØ¨ÙˆÙŠØ¨: ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© -->
    <section id="tab-dept" class="tab-panel is-active" role="tabpanel" aria-labelledby="tab-dept">
      <section class="panel">
        <div class="toolbar">
          <button id="addRow" class="btn ghost">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù</button>
          <button id="saveDay" class="btn primary">Ø­ÙØ¸ Ø§Ù„ÙŠÙˆÙ…</button>
          <button id="exportCSV" class="btn accent">ØªØµØ¯ÙŠØ± CSV</button>
          <button id="finalize" class="btn warn">ØªÙˆØ¬ÙŠÙ‡ Ù„Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©</button>
          <input id="search" class="search" type="text" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…â€¦">
        </div>

        <div class="table-wrap">
          <table id="tbl" aria-label="Ø³Ø¬Ù„ Ø§Ù„ÙŠÙˆÙ…">
            <thead>
              <tr>
                <th style="width:22%">Ø§Ù„Ù…ÙˆØ¸Ù</th>
                <th style="width:12%">Ø§Ù„Ù…Ø±ØªØ¨Ø©</th>
                <th style="width:12%">Ø§Ù„Ø­Ø¶ÙˆØ±</th>
                <th style="width:12%">Ø§Ù„Ø§Ù†ØµØ±Ø§Ù</th>
                <th style="width:14%">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                <th style="width:10%">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
          <div id="empty" class="empty" hidden>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ….</div>
        </div>

        <div id="summary" class="sum">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 0 | Ø­Ø§Ø¶Ø±: 0 | Ù…ØªØ£Ø®Ø±: 0 | ØºÙŠØ§Ø¨: 0 | Ø¥Ø¬Ø§Ø²Ø©: 0 | Ø§Ø³ØªØ¦Ø°Ø§Ù†: 0</div>
        <div class="hint">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¥Ø°Ø§ ÙˆØµÙ„Øª Ø§Ù„ØµÙØ­Ø© Ø¹Ø¨Ø± ØªØ­ÙˆÙŠÙ„ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ù…ÙˆØ¸ÙØŒ Ø³ÙŠØªÙ… Ø¯Ù…Ø¬ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø±Ø³Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù„Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø±ÙŠØ®.</div>
      </section>
    </section>

    <!-- ØªØ¨ÙˆÙŠØ¨: Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø¯ÙŠØ± (Ù†ÙØ³ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†) -->
    <section id="tab-mgr" class="tab-panel" role="tabpanel" aria-labelledby="tab-mgr">
      <section class="panel">
        <h2 style="margin:0 0 10px;font-size:18px">Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø¯ÙŠØ± (Ø´Ø®ØµÙŠ)</h2>

        <div class="row two">
          <label>Ø§Ù„Ø§Ø³Ù…
            <input type="text" id="mgrSelfName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ±">
          </label>
          <label>Ø§Ù„Ù…Ø±ØªØ¨Ø©/Ø§Ù„Ø¯Ø±Ø¬Ø©
            <input type="text" id="mgrSelfRank" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø¯ÙŠØ± Ø¥Ø¯Ø§Ø±Ø© / Ø§Ù„Ù…Ø±ØªØ¨Ø© Ø§Ù„Ø¹Ø§Ø´Ø±Ø©">
          </label>
        </div>

        <h3 class="sub">Ø§Ù„ØªØ­Ø¶ÙŠØ±</h3>
        <div class="row four">
          <label>Ø§Ù„ÙˆÙ‚Øª
            <input type="time" id="mgrSelfTime">
          </label>

          <label>Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
            <select id="mgrSelfReq">
              <option value="">â€” Ø¨Ø¯ÙˆÙ† Ø·Ù„Ø¨ â€”</option>
              <option value="partial">Ø§Ø³ØªØ¦Ø°Ø§Ù† Ø¬Ø²Ø¦ÙŠ</option>
              <option value="full">Ø§Ø³ØªØ¦Ø°Ø§Ù† ÙƒÙ„ÙŠ</option>
              <option value="leave">Ø¥Ø¬Ø§Ø²Ø©</option>
            </select>
          </label>

          <button id="mgrSelfIn" class="btn primary">
            <svg class="ic" viewBox="0 0 24 24" aria-hidden="true"><path d="M3 12h11m-3-3l3 3-3 3M7 5h10a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H7" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
            ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±
          </button>

          <button id="mgrSelfOut" class="btn">
            <svg class="ic" viewBox="0 0 24 24" aria-hidden="true"><path d="M14 12H3m3 3-3-3 3-3M7 5h10a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H7" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
            ØªØ³Ø¬ÙŠÙ„ Ø§Ù†ØµØ±Ø§Ù
          </button>
        </div>

        <div class="list">
          <h3 class="sub">Ø³Ø¬Ù„ Ø§Ù„ÙŠÙˆÙ…</h3>
          <ul id="mgrSelfLog" class="log"></ul>
        </div>
      </section>
    </section>
  </main>
</div>

<div class="toast" id="toast"><span></span></div>

<script>
(function(){
  /* ===== Ù…Ø³Ø§Ø¹Ø¯Ø§Øª Ø¹Ø§Ù…Ø© ===== */
  const $ = (s,p=document)=>p.querySelector(s);
  const $$ = (s,p=document)=>Array.from(p.querySelectorAll(s));
  const toast = (msg)=>{ const t=document.getElementById('toast'); t.querySelector('span').textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1400); };
  const pad = n => String(n).padStart(2,'0');
  const todayISO = ()=>{ const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; };
  const nowHM = ()=>{ const d=new Date(); return d.toTimeString().slice(0,5); };

  /* ===== ØªØ¨ÙˆÙŠØ¨Ø§Øª ===== */
  const tabs = $$('.tab');
  const panels = { dept: $('#tab-dept'), mgr: $('#tab-mgr') };
  function activate(name){
    tabs.forEach(t=>{
      const on = t.dataset.tab===name;
      t.classList.toggle('is-active', on);
      t.setAttribute('aria-selected', on?'true':'false');
    });
    Object.entries(panels).forEach(([k,el])=>{
      el.classList.toggle('is-active', k===name);
    });
    localStorage.setItem('mgr:view', name);
  }
  tabs.forEach(t=> t.addEventListener('click', ()=> activate(t.dataset.tab)));

  /* ===== ØªØ®Ø²ÙŠÙ† ===== */
  const MGR_KEY = 'mgr_records_v1';      // { 'YYYY-MM-DD': [rows] }
  const DEPT_KEY = 'mgr_dept';
  const FINAL_KEY = 'mgr_finalized_v1';

  const load = (k, fb)=> { try{return JSON.parse(localStorage.getItem(k) || fb);}catch(_){return JSON.parse(fb);} };
  const save = (k, obj)=> localStorage.setItem(k, JSON.stringify(obj));

  /* ===== Ø¹Ù†Ø§ØµØ± Ø¹Ø§Ù…Ø© (ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©) ===== */
  const dayEl = document.getElementById('day');
  const deptEl = document.getElementById('dept');
  const tbody = document.getElementById('tbody');
  const empty = document.getElementById('empty');
  const summary = document.getElementById('summary');
  const searchEl = document.getElementById('search');
  const addRowBtn = document.getElementById('addRow');
  const saveBtn = document.getElementById('saveDay');
  const exportBtn = document.getElementById('exportCSV');
  const finalizeBtn = document.getElementById('finalize');

  const params = new URLSearchParams(location.search);
  dayEl.value = params.get('date') || todayISO();
  deptEl.value = localStorage.getItem(DEPT_KEY) || '';
  deptEl.addEventListener('input', ()=> localStorage.setItem(DEPT_KEY, deptEl.value));

  function getDayRows(date){
    const all = load(MGR_KEY, '{}');
    return all[date] || [];
  }
  function setDayRows(date, rows){
    const all = load(MGR_KEY, '{}');
    all[date] = rows;
    save(MGR_KEY, all);
  }

  /* ===== Ø¯Ù…Ø¬ Ø³Ø¬Ù„ ÙˆØ§Ø±Ø¯ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ù…ÙˆØ¸Ù ===== */
  function mergeIncoming(){
    const raw = sessionStorage.getItem('last_attendance_payload');
    if(!raw) return false;
    const p = JSON.parse(raw);
    if(!p || !p.date || p.date !== dayEl.value) return false;

    let rows = getDayRows(dayEl.value);
    const name = (p.account && p.account.name) ? String(p.account.name).trim() : 'â€”';
    const rank = (p.account && p.account.rank) ? String(p.account.rank).trim() : 'â€”';
    const hudur = p.hudur || '';
    const insiraf = p.insiraf || '';

    const idx = rows.findIndex(r => (r.name||'').trim() === name);
    if(idx >= 0){
      rows[idx].hudur = hudur || rows[idx].hudur;
      rows[idx].insiraf = insiraf || rows[idx].insiraf;
      if(!rows[idx].rank) rows[idx].rank = rank;
    }else{
      rows.push({ id: crypto.randomUUID(), name, rank, hudur, insiraf, status:'', note:'' });
    }
    setDayRows(dayEl.value, rows);
    sessionStorage.removeItem('last_attendance_payload');
    return true;
  }

  /* ===== Ø¨Ù†Ø§Ø¡ ØµÙ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ===== */
  function statusClass(v){
    return v==='Ø­Ø§Ø¶Ø±'?'row-present' : v==='Ù…ØªØ£Ø®Ø±'?'row-late' : v==='ØºÙŠØ§Ø¨'?'row-absent' : v==='Ø¥Ø¬Ø§Ø²Ø©'?'row-leave' : v==='Ø§Ø³ØªØ¦Ø°Ø§Ù†'?'row-permit' : '';
  }
  function buildRow(r){
    const tr = document.createElement('tr');
    tr.dataset.id = r.id;
    if(r.status) tr.classList.add(statusClass(r.status));

    const tdName = document.createElement('td');
    const inName = document.createElement('input'); inName.type='text'; inName.value=r.name||'';
    tdName.appendChild(inName);

    const tdRank = document.createElement('td');
    const inRank = document.createElement('input'); inRank.type='text'; inRank.value=r.rank||'';
    tdRank.appendChild(inRank);

    const tdHud = document.createElement('td');
    const inHud = document.createElement('input'); inHud.type='time'; inHud.value=r.hudur||'';
    tdHud.appendChild(inHud);

    const tdIns = document.createElement('td');
    const inIns = document.createElement('input'); inIns.type='time'; inIns.value=r.insiraf||'';
    tdIns.appendChild(inIns);

    const tdSt = document.createElement('td');
    const sel = document.createElement('select');
    ['','Ø­Ø§Ø¶Ø±','Ù…ØªØ£Ø®Ø±','ØºÙŠØ§Ø¨','Ø¥Ø¬Ø§Ø²Ø©','Ø§Ø³ØªØ¦Ø°Ø§Ù†'].forEach(v=>{
      const o=document.createElement('option'); o.value=v; o.textContent=(v||'â€” Ø§Ø®ØªØ± â€”');
      if(v===r.status) o.selected=true; sel.appendChild(o);
    });
    tdSt.appendChild(sel);

    const tdNote = document.createElement('td');
    const inNote = document.createElement('input'); inNote.type='text'; inNote.placeholder='Ù…Ù„Ø§Ø­Ø¸Ø©â€¦'; inNote.value=r.note||'';
    tdNote.appendChild(inNote);

    const tdAct = document.createElement('td');
    const del = document.createElement('button'); del.className='btn ghost'; del.textContent='Ø­Ø°Ù';
    tdAct.appendChild(del);

    function persist(){
      const rows = getDayRows(dayEl.value);
      const i = rows.findIndex(x=>x.id===r.id);
      if(i>=0){
        rows[i].name = inName.value.trim();
        rows[i].rank = inRank.value.trim();
        rows[i].hudur = inHud.value;
        rows[i].insiraf = inIns.value;
        rows[i].status = sel.value;
        rows[i].note = inNote.value.trim();
        setDayRows(dayEl.value, rows);
        renderSummary(rows);
        tr.className=''; if(sel.value) tr.classList.add(statusClass(sel.value));
      }
    }
    [inName,inRank,inHud,inIns,sel,inNote].forEach(el=> el.addEventListener('change', persist));

    del.addEventListener('click', ()=>{
      let rows = getDayRows(dayEl.value);
      rows = rows.filter(x=>x.id!==r.id);
      setDayRows(dayEl.value, rows);
      render();
    });

    tr.append(tdName,tdRank,tdHud,tdIns,tdSt,tdNote,tdAct);
    return tr;
  }

  /* ===== Ø±Ø³Ù… Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ===== */
  function render(){
    const q = searchEl.value.trim();
    const rows = getDayRows(dayEl.value);
    tbody.innerHTML = '';
    let shown = rows;

    if(q){
      const qq = q.toLowerCase();
      shown = rows.filter(r => (r.name||'').toLowerCase().includes(qq));
    }

    empty.hidden = shown.length!==0;
    shown.forEach(r => tbody.appendChild(buildRow(r)));
    renderSummary(rows);

    const finAll = load(FINAL_KEY,'{}');
    finalizeBtn.disabled = !!finAll[dayEl.value];
  }

  function renderSummary(rows){
    const total = rows.length;
    const count = s=> rows.filter(r=>r.status===s).length;
    summary.textContent = `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total} | Ø­Ø§Ø¶Ø±: ${count('Ø­Ø§Ø¶Ø±')} | Ù…ØªØ£Ø®Ø±: ${count('Ù…ØªØ£Ø®Ø±')} | ØºÙŠØ§Ø¨: ${count('ØºÙŠØ§Ø¨')} | Ø¥Ø¬Ø§Ø²Ø©: ${count('Ø¥Ø¬Ø§Ø²Ø©')} | Ø§Ø³ØªØ¦Ø°Ø§Ù†: ${count('Ø§Ø³ØªØ¦Ø°Ø§Ù†')}`;
  }

  /* ===== Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ===== */
  dayEl.addEventListener('change', ()=> render());
  searchEl.addEventListener('input', ()=> render());

  addRowBtn.addEventListener('click', ()=>{
    const rows = getDayRows(dayEl.value);
    rows.push({ id: crypto.randomUUID(), name:'', rank:'', hudur:'', insiraf:'', status:'', note:'' });
    setDayRows(dayEl.value, rows);
    render();
  });

  saveBtn.addEventListener('click', ()=> toast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙŠÙˆÙ….'));
  exportBtn.addEventListener('click', ()=>{
    const rows = getDayRows(dayEl.value);
    const head = ['Ø§Ù„Ø§Ø³Ù…','Ø§Ù„Ù…Ø±ØªØ¨Ø©','Ø§Ù„Ø­Ø¶ÙˆØ±','Ø§Ù„Ø§Ù†ØµØ±Ø§Ù','Ø§Ù„Ø­Ø§Ù„Ø©','Ù…Ù„Ø§Ø­Ø¸Ø§Øª'];
    const lines = [head.join(',')];
    rows.forEach(r=>{
      const cells = [r.name||'',r.rank||'',r.hudur||'',r.insiraf||'',r.status||'', (r.note||'').replace(/,/g,';')];
      lines.push(cells.map(v=>`"${(v||'').replace(/"/g,'""')}"`).join(','));
    });
    const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href=url; a.download=`attendance_${dayEl.value}.csv`; a.click();
    URL.revokeObjectURL(url);
  });
  finalizeBtn.addEventListener('click', ()=>{
    const finAll = load(FINAL_KEY,'{}');
    if(finAll[dayEl.value]){ toast('ØªÙ… ØªÙˆØ¬ÙŠÙ‡ Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ… Ù…Ø³Ø¨Ù‚Ù‹Ø§.'); return; }
    finAll[dayEl.value] = { dept: deptEl.value || '', timestamp: new Date().toISOString() };
    save(FINAL_KEY, finAll);
    finalizeBtn.disabled = true;
    toast('ØªÙ… Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ© ğŸ¯');
  });

  /* ===== ØªØ¨ÙˆÙŠØ¨: Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø¯ÙŠØ± ===== */
  const mgrSelfName = document.getElementById('mgrSelfName');
  const mgrSelfRank = document.getElementById('mgrSelfRank');
  const mgrSelfTime = document.getElementById('mgrSelfTime');
  const mgrSelfReq  = document.getElementById('mgrSelfReq');
  const mgrSelfIn   = document.getElementById('mgrSelfIn');
  const mgrSelfOut  = document.getElementById('mgrSelfOut');
  const mgrSelfLog  = document.getElementById('mgrSelfLog');

  function reqLabel(v){ return v==='partial'?'Ø§Ø³ØªØ¦Ø°Ø§Ù† Ø¬Ø²Ø¦ÙŠ' : v==='full'?'Ø§Ø³ØªØ¦Ø°Ø§Ù† ÙƒÙ„ÙŠ' : v==='leave'?'Ø¥Ø¬Ø§Ø²Ø©' : ''; }
  function keySelf(prefix){ return `${prefix}:${dayEl.value}:mgrSelf`; }
  function loadSelfLog(){
    mgrSelfLog.innerHTML='';
    const arr = load(keySelf('mgrSelfLog'), '[]');
    arr.forEach(item=>{ const li=document.createElement('li'); li.textContent=item; mgrSelfLog.appendChild(li); });
  }
  function pushSelfLog(text){
    const arr = load(keySelf('mgrSelfLog'), '[]');
    arr.push(text); save(keySelf('mgrSelfLog'), arr); loadSelfLog();
  }
  function ensureManagerRow(){
    const name = (mgrSelfName.value||'').trim(); const rank = (mgrSelfRank.value||'').trim();
    if(!name) return null;
    let rows = getDayRows(dayEl.value);
    let r = rows.find(x => (x.name||'').trim() === name);
    if(!r){ r = { id: crypto.randomUUID(), name, rank, hudur:'', insiraf:'', status:'', note:'' }; rows.push(r); }
    else if(rank && !r.rank){ r.rank = rank; }
    setDayRows(dayEl.value, rows); return r.id;
  }
  function setManagerHudur(time){
    const id = ensureManagerRow(); if(!id) return;
    let rows = getDayRows(dayEl.value); const i = rows.findIndex(x=>x.id===id);
    if(i>=0){ rows[i].hudur = time; setDayRows(dayEl.value, rows); render(); }
  }
  function setManagerInsiraf(time){
    const id = ensureManagerRow(); if(!id) return;
    let rows = getDayRows(dayEl.value); const i = rows.findIndex(x=>x.id===id);
    if(i>=0){ rows[i].insiraf = time; setDayRows(dayEl.value, rows); render(); }
  }

  function hydrateManagerIdentity(){
    const p = new URLSearchParams(location.search);
    const storedName = localStorage.getItem('managerName') || '';
    const storedRank = localStorage.getItem('managerRank') || '';
    const finalName = (p.get('name')||storedName||'').trim();
    const finalRank = (p.get('rank')||storedRank||'').trim();
    if(finalName) localStorage.setItem('managerName', finalName);
    if(finalRank) localStorage.setItem('managerRank', finalRank);
    mgrSelfName.value = finalName;
    mgrSelfRank.value = finalRank;
  }

  function initSelfPanel(){
    if(!mgrSelfTime) return;
    mgrSelfTime.value = nowHM();
    hydrateManagerIdentity();
    loadSelfLog();

    [mgrSelfName, mgrSelfRank].forEach(el=>{
      el && el.addEventListener('change', ()=>{
        if(el===mgrSelfName) localStorage.setItem('managerName', (mgrSelfName.value||'').trim());
        if(el===mgrSelfRank) localStorage.setItem('managerRank', (mgrSelfRank.value||'').trim());
      });
    });

    mgrSelfIn && mgrSelfIn.addEventListener('click', ()=>{
      const n = (mgrSelfName.value||'Ù…Ø¯ÙŠØ±').trim();
      const r = (mgrSelfRank.value||'â€”').trim();
      const t = mgrSelfTime.value || nowHM();
      const extra = reqLabel(mgrSelfReq.value);
      pushSelfLog(`Ø­Ø¶ÙˆØ±: ${n} (${r}) Ø¹Ù†Ø¯ ${t}${extra?(' â€” '+extra):''}`);
      setManagerHudur(t);
      toast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø¯ÙŠØ±');
    });

    mgrSelfOut && mgrSelfOut.addEventListener('click', ()=>{
      const n = (mgrSelfName.value||'Ù…Ø¯ÙŠØ±').trim();
      const r = (mgrSelfRank.value||'â€”').trim();
      const t = mgrSelfTime.value || nowHM();
      const extra = reqLabel(mgrSelfReq.value);
      pushSelfLog(`Ø§Ù†ØµØ±Ø§Ù: ${n} (${r}) Ø¹Ù†Ø¯ ${t}${extra?(' â€” '+extra):''}`);
      setManagerInsiraf(t);
      toast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù†ØµØ±Ø§Ù Ø§Ù„Ù…Ø¯ÙŠØ±');
    });
  }

  /* ===== Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ ===== */
  activate(localStorage.getItem('mgr:view') || 'dept'); // Ø§ÙØªØ±Ø§Ø¶ÙŠ: ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
  mergeIncoming();
  render();
  initSelfPanel();
})();
</script>
</body>
</html>