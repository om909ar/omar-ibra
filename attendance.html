<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>الحضور والانصراف – الموظف</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;font-family:'Tajawal',system-ui,-apple-system,Segoe UI,Arial;
    background:linear-gradient(#8e9a95,#7f8a85);color:#1f2421
  }
  .wrap{max-width:900px;margin:0 auto;padding:20px}

  /* رأس */
  .head{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
  .head h1{margin:0;font-size:22px;color:#fff;text-shadow:0 1px 0 rgba(0,0,0,.25)}
  .meta{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .meta input[type=date]{
    padding:8px 10px;border:1px solid #d5d8dc;border-radius:999px;background:#e9efe9;min-width:160px
  }

  /* لوحة */
  .panel{
    background:#e9eceb;border:1px solid rgba(0,0,0,.12);border-radius:10px;padding:16px;
    box-shadow:0 4px 0 rgba(0,0,0,.25);margin-top:20px
  }

  /* نموذج الموظف */
  .sub{margin:16px 0 8px;font-size:16px}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .row.two > *{flex:1 1 240px}
  .row.four > *{flex:1 1 160px}
  label{display:flex;flex-direction:column;gap:6px}
  input[type=text],input[type=time],select{
    padding:10px 12px;border:1px solid #cfd6d2;border-radius:8px;background:#fff;min-width:160px
  }
  .readonly{background:#f4f6f7}

  /* أزرار */
  .btn{border:1px solid #c9ced3;background:#eef1f4;border-radius:10px;padding:10px 14px;cursor:pointer;
    display:inline-flex;align-items:center;gap:8px;font-weight:600}
  .btn.primary{background:#316655;color:#fff;border-color:#316655}
  .btn.accent{background:#2d6a8e;color:#fff;border-color:#2d6a8e}
  .btn .ic{width:18px;height:18px}

  /* سجل */
  .log{list-style:none;margin:8px 0 0;padding:0}
  .log li{background:#f9fbfc;border:1px solid #dfe5e2;padding:8px 10px;border-radius:8px;margin-bottom:6px;font-size:14px}

  /* توست */
  .toast{position:fixed;inset-inline:0;bottom:16px;display:flex;justify-content:center;pointer-events:none;z-index:9999}
  .toast span{background:#111;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transform:translateY(10px);transition:.2s}
  .toast.show span{opacity:1;transform:none}
</style>
</head>
<body>
<div class="wrap">
  <header class="head">
    <h1>الحضور والانصراف – الموظف</h1>
    <div class="meta">
      <label>تاريخ اليوم:
        <input type="date" id="day">
      </label>
    </div>
  </header>

  <section class="panel">
    <div class="row two">
      <label>الاسم
        <input type="text" id="empName" class="readonly" placeholder="اسم الموظف" readonly>
      </label>
      <label>المرتبة/الدرجة
        <input type="text" id="empRank" class="readonly" placeholder="مثال: المرتبة السادسة" readonly>
      </label>
    </div>

    <h3 class="sub">التحضير</h3>
    <div class="row four">
      <label>الوقت
        <input type="time" id="empTime">
      </label>

      <label>نوع الطلب (اختياري)
        <select id="empReq">
          <option value="">— بدون طلب —</option>
          <option value="partial">استئذان جزئي</option>
          <option value="full">استئذان كلي</option>
          <option value="leave">إجازة</option>
        </select>
      </label>

      <button id="btnIn" class="btn primary" title="تسجيل حضور">
        <svg class="ic" viewBox="0 0 24 24" aria-hidden="true"><path d="M3 12h11m-3-3l3 3-3 3M7 5h10a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H7" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
        تسجيل حضور
      </button>

      <button id="btnOut" class="btn" title="تسجيل انصراف">
        <svg class="ic" viewBox="0 0 24 24" aria-hidden="true"><path d="M14 12H3m3 3-3-3 3-3M7 5h10a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H7" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
        تسجيل انصراف
      </button>
    </div>

    <div class="row" style="margin-top:8px">
      <button id="btnSend" class="btn accent">إرسال السجل إلى لوحة المدير</button>
    </div>

    <div class="list">
      <h3 class="sub">سجل اليوم</h3>
      <ul id="empLog" class="log"></ul>
    </div>
  </section>
</div>

<div class="toast" id="toast"><span></span></div>

<script>
(function(){
  /* ===== مساعدات عامة ===== */
  const $ = (s,p=document)=>p.querySelector(s);
  const toast = (msg)=>{ const t=$('#toast'); t.querySelector('span').textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1400); };
  const pad = n => String(n).padStart(2,'0');
  const todayISO = ()=>{ const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; };
  const nowHM = ()=>{ const d=new Date(); return d.toTimeString().slice(0,5); };
  const load = (k, fb)=> { try{return JSON.parse(localStorage.getItem(k) || fb);}catch(_){return JSON.parse(fb);} };
  const save = (k, obj)=> localStorage.setItem(k, JSON.stringify(obj));

  /* ===== عناصر الصفحة ===== */
  const dayEl = $('#day');
  const empName = $('#empName');
  const empRank = $('#empRank');
  const empTime = $('#empTime');
  const empReq  = $('#empReq');
  const btnIn   = $('#btnIn');
  const btnOut  = $('#btnOut');
  const btnSend = $('#btnSend');
  const empLog  = $('#empLog');

  /* ===== هوية الموظف (URL أو localStorage) ===== */
  function hydrateIdentity(){
    const p = new URLSearchParams(location.search);
    const storedName = localStorage.getItem('accountName') || '';
    const storedRank = localStorage.getItem('accountRank') || '';
    const finalName = (p.get('name')||storedName||'').trim();
    const finalRank = (p.get('rank')||storedRank||'').trim();
    if(finalName) localStorage.setItem('accountName', finalName);
    if(finalRank) localStorage.setItem('accountRank', finalRank);
    empName.value = finalName || '—';
    empRank.value = finalRank || '—';
  }

  /* ===== تاريخ افتراضي ===== */
  const params = new URLSearchParams(location.search);
  dayEl.value = params.get('date') || todayISO();

  /* ===== سجل اليوم للموظف ===== */
  function kLog(){ return `empLog:${dayEl.value}`; }
  function loadLog(){
    empLog.innerHTML='';
    const arr = load(kLog(), '[]');
    arr.forEach(item=>{ const li=document.createElement('li'); li.textContent=item; empLog.appendChild(li); });
  }
  function pushLog(text){
    const arr = load(kLog(), '[]'); arr.push(text); save(kLog(), arr); loadLog();
  }

  /* ===== إدارة حمولة التحويل للمدير ===== */
  let selfHudur = ''; let selfInsiraf = '';
  function reqLabel(v){ return v==='partial'?'استئذان جزئي' : v==='full'?'استئذان كلي' : v==='leave'?'إجازة' : ''; }

  function setPayloadAndOptionallyNavigate(go=false){
    const payload = {
      date: dayEl.value,
      account: { name: empName.value || '', rank: empRank.value || '' },
      hudur: selfHudur || '',
      insiraf: selfInsiraf || ''
    };
    sessionStorage.setItem('last_attendance_payload', JSON.stringify(payload));
    if(go){
      const q = new URLSearchParams({
        date: dayEl.value,
        name: empName.value || '',
        rank: empRank.value || ''
      }).toString();
      // نفس مجلد الصفحة
      location.href = `manager.html?${q}`;
    }
  }

  /* ===== أحداث الأزرار ===== */
  btnIn.addEventListener('click', ()=>{
    const n = (empName.value||'موظف').trim();
    const r = (empRank.value||'—').trim();
    const t = empTime.value || nowHM();
    const extra = reqLabel(empReq.value);
    selfHudur = t;
    pushLog(`حضور: ${n} (${r}) عند ${t}${extra?(' — '+extra):''}`);
    setPayloadAndOptionallyNavigate(false);
    toast('تم تسجيل الحضور');
  });

  btnOut.addEventListener('click', ()=>{
    const n = (empName.value||'موظف').trim();
    const r = (empRank.value||'—').trim();
    const t = empTime.value || nowHM();
    const extra = reqLabel(empReq.value);
    selfInsiraf = t;
    pushLog(`انصراف: ${n} (${r}) عند ${t}${extra?(' — '+extra):''}`);
    setPayloadAndOptionallyNavigate(false);
    toast('تم تسجيل الانصراف');
  });

  btnSend.addEventListener('click', ()=>{
    setPayloadAndOptionallyNavigate(true); // خزّن واذهب لصفحة المدير
  });

  /* ===== تهيئة ===== */
  function init(){
    hydrateIdentity();
    empTime.value = nowHM();
    loadLog();
  }
  init();
})();
</script>
</body>
</html>